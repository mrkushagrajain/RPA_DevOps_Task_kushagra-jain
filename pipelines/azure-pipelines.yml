trigger:
  branches:
    include:
      - main

variables:
  pythonVersion: "3.10"
  artifactName: "bot_artifacts"

stages:
# =========================
# BUILD & VALIDATE
# =========================
- stage: BuildAndValidate
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: $(pythonVersion)

    - bash: |
        python3 -m pip install --upgrade pip
        python3 -m pip install pyyaml requests
      displayName: "Install Python dependencies"

    - bash: |
        python3 scripts/validate_artifacts.py
        python3 scripts/package_bot.py
      displayName: "Validate and Package Bot"

    - publish: dist
      artifact: $(artifactName)

# =========================
# DEPLOY DEV
# =========================
- stage: Deploy_Dev
  dependsOn: BuildAndValidate
  jobs:
  - job: Dev
    pool:
      vmImage: ubuntu-latest
    steps:
    - download: current
      artifact: $(artifactName)

    - task: UsePythonVersion@0
      inputs:
        versionSpec: $(pythonVersion)

    - bash: |
        python3 -m pip install pyyaml
        mkdir -p reports/junit logs
        ART=$(ls $(Pipeline.Workspace)/$(artifactName)/*.zip | head -n 1)
        python3 scripts/aa_deploy.py --env dev --artifact "$ART" --mock
      displayName: "Deploy DEV (mock)"

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: JUnit
        testResultsFiles: "reports/junit/*.xml"
        failTaskOnFailedTests: false

    - task: PublishPipelineArtifact@1
      condition: always()
      inputs:
        targetPath: logs
        artifact: logs-dev

# =========================
# DEPLOY TEST
# =========================
- stage: Deploy_Test
  dependsOn: Deploy_Dev
  condition: succeeded()
  jobs:
  - job: Test
    pool:
      vmImage: ubuntu-latest
    steps:
    - download: current
      artifact: $(artifactName)

    - task: UsePythonVersion@0
      inputs:
        versionSpec: $(pythonVersion)

    - bash: |
        python3 -m pip install pyyaml
        mkdir -p reports/junit logs
        ART=$(ls $(Pipeline.Workspace)/$(artifactName)/*.zip | head -n 1)
        python3 scripts/aa_deploy.py --env test --artifact "$ART" --mock
      displayName: "Deploy TEST (mock)"

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: JUnit
        testResultsFiles: "reports/junit/*.xml"
        failTaskOnFailedTests: false

    - task: PublishPipelineArtifact@1
      condition: always()
      inputs:
        targetPath: logs
        artifact: logs-test

# =========================
# DEPLOY PROD
# =========================
- stage: Deploy_Prod
  dependsOn: Deploy_Test
  condition: succeeded()
  jobs:
  - job: Prod
    pool:
      vmImage: ubuntu-latest
    steps:
    - download: current
      artifact: $(artifactName)

    - task: UsePythonVersion@0
      inputs:
        versionSpec: $(pythonVersion)

    - bash: |
        python3 -m pip install pyyaml
        mkdir -p reports/junit logs
        ART=$(ls $(Pipeline.Workspace)/$(artifactName)/*.zip | head -n 1)
        python3 scripts/aa_deploy.py --env prod --artifact "$ART" --mock
      displayName: "Deploy PROD (mock)"

    - task: PublishTestResults@2
      condition: always()
      inputs:
        testResultsFormat: JUnit
        testResultsFiles: "reports/junit/*.xml"
        failTaskOnFailedTests: false

    - task: PublishPipelineArtifact@1
      condition: always()
      inputs:
        targetPath: logs
        artifact: logs-prod
